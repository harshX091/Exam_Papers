<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Papers</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <header class="header">
    <h1 id="pageTitle">Papers</h1>
    <p id="pageSub">View or download</p>
  </header>

  <main class="container">
    <!-- keep anchor for non-JS fallback; add data-fallback for script -->
    <a id="backLink" class="back" data-fallback="index.html" href="index.html">⬅ Back</a>

    <div id="controls" style="display:flex;gap:12px;align-items:center;margin:12px 0;flex-wrap:wrap">
      <div class="toggle-group" style="display:flex;gap:0;">
        <button id="viewPapers" class="toggle-btn active"
          style="padding:6px 12px;cursor:pointer;background:#007bff;color:white;border:1px solid #007bff;border-radius:4px 0 0 4px">Papers</button>
        <button id="viewSyllabus" class="toggle-btn"
          style="padding:6px 12px;cursor:pointer;background:#f0f0f0;color:black;border:1px solid #ccc;border-left:none;border-radius:0 4px 4px 0">Syllabus</button>
      </div>
      <input id="filterYear" class="search" placeholder="Filter by year (e.g. 2024)" />
      <button id="clearFilter" class="btn">Clear</button>
    </div>

    <div id="listArea"></div>

  </main>

  <script>
    // get params and normalize semester value
    const params = new URLSearchParams(location.search);
    const semRaw = params.get('sem') || 'Sem_1';
    let sem = semRaw;
    if (/^\d+$/.test(semRaw)) sem = `Sem_${semRaw}`;
    sem = sem.replace(/\s+/g, '_');
    const subject = params.get('subject') || 'Physics';

    // View mode: 'papers' or 'syllabus'
    let currentView = params.get('view') || 'papers';

    document.getElementById('pageTitle').innerText = `${sem.replace(/_/g, ' ')} — ${subject.replace(/_/g, ' ')}`;
    document.getElementById('pageSub').innerText = "Click View to open within page or Download to save";

    const btnPapers = document.getElementById('viewPapers');
    const btnSyllabus = document.getElementById('viewSyllabus');
    const filterInput = document.getElementById('filterYear');

    function updateViewUI() {
      if (currentView === 'syllabus') {
        btnSyllabus.style.background = '#007bff';
        btnSyllabus.style.color = 'white';
        btnSyllabus.style.borderColor = '#007bff';

        btnPapers.style.background = '#f0f0f0';
        btnPapers.style.color = 'black';
        btnPapers.style.borderColor = '#ccc';

        filterInput.style.display = 'block';
        filterInput.placeholder = "Search topics, units...";
      } else {
        btnPapers.style.background = '#007bff';
        btnPapers.style.color = 'white';
        btnPapers.style.borderColor = '#007bff';

        btnSyllabus.style.background = '#f0f0f0';
        btnSyllabus.style.color = 'black';
        btnSyllabus.style.borderColor = '#ccc';

        filterInput.style.display = 'block';
        filterInput.placeholder = "Filter by year (e.g. 2024)";
      }
      // Re-apply current filter if any
      const val = filterInput.value.trim();
      applyFilter(val);
    }

    function updateUrlParams(key, value) {
      const url = new URL(window.location);
      url.searchParams.set(key, value);
      window.history.replaceState({}, '', url);
    }

    btnPapers.addEventListener('click', () => {
      currentView = 'papers';
      filterInput.value = '';
      updateUrlParams('view', 'papers');
      updateViewUI();
      loadData();
    });
    btnSyllabus.addEventListener('click', () => {
      currentView = 'syllabus';
      filterInput.value = '';
      updateUrlParams('view', 'syllabus');
      updateViewUI();
      loadData();
    });

    // Initial UI set
    updateViewUI();
    filterInput.value = ''; // Force clear on reload

    let papersData = [];
    let syllabusData = [];

    // Global Error Handler
    window.onerror = function (msg, url, lineNo, columnNo, error) {
      const area = document.getElementById('listArea');
      if (area) {
        area.innerHTML = `<div style="color:red;padding:10px;border:1px solid red;background:#xfff">
          <strong>Runtime Error:</strong> ${msg}
        </div>` + area.innerHTML;
      }
      return false;
    };

    // Scroll restoration logic
    document.getElementById('listArea').addEventListener('click', (e) => {
      if (e.target.closest('.view-btn')) {
        sessionStorage.setItem('scrollPos', window.scrollY);
      }
    });

    async function loadData() {
      const area = document.getElementById('listArea');
      // Only show loading if we are actually fetching, or if the area is empty. 
      // If we are just re-rendering, maybe don't wipe it? 
      // But here we are fetching.
      area.innerHTML = '<p>Loading...</p>';

      try {
        if (currentView === 'syllabus') {
          const file = `data/syllabus_${sem.toLowerCase()}.json`;
          const res = await fetch(file);
          if (!res.ok) throw new Error(`Failed to load ${file}: ${res.statusText}`);
          const data = await res.json();
          const subjData = data.find(s => s.subject.toLowerCase() === subject.toLowerCase());
          syllabusData = subjData ? subjData.units : [];

          if (!subjData) console.warn('Subject not found:', subject);

          applyFilter(filterInput.value.trim());
        } else {
          const file = `data/${sem.toLowerCase()}.json`;
          const res = await fetch(file);
          if (!res.ok) throw new Error(`Failed to load ${file}: ${res.statusText}`);
          const data = await res.json();
          papersData = data.filter(p => p.subject.toLowerCase() === subject.toLowerCase());
          applyFilter(filterInput.value.trim());
        }

        // Restore scroll if exists
        const savedScroll = sessionStorage.getItem('scrollPos');
        if (savedScroll) {
          window.scrollTo(0, parseInt(savedScroll));
          sessionStorage.removeItem('scrollPos');
        }

      } catch (err) {
        area.innerHTML = `<div class="empty" style="color:red">
          <p>Error loading content for <strong>${subject}</strong>.</p>
          <p>${err.message}</p>
        </div>`;
        console.error(err);
      }
    }

    function renderPapers(items) {
      const area = document.getElementById('listArea');
      area.innerHTML = '';
      if (items.length === 0) {
        area.innerHTML = `<p class="empty">No papers available.</p>`;
        return;
      }

      items.forEach(p => {
        const d = document.createElement('div');
        d.className = 'paper-card';
        const filePath = encodeURI(String(p.file || '').replace(/^\/+/, ''));
        const viewerLink = `viewer.html?file=${encodeURIComponent(filePath)}&title=${encodeURIComponent(p.title)}`;
        d.innerHTML = `
          <div class="paper-info">
            <div class="paper-title">${p.title}</div>
            <div class="paper-sub">${p.subject} • ${p.year} • ${p.description || ''}</div>
          </div>
          <div class="actions">
            <a class="view-btn" href="${viewerLink}">View</a>
            <a class="dl-btn" href="${filePath}" download>Download</a>
          </div>
        `;
        area.appendChild(d);
      });
    }

    function renderSyllabus(units) {
      const area = document.getElementById('listArea');
      area.innerHTML = '';
      if (!units || units.length === 0) {
        area.innerHTML = `<p class="empty">No syllabus details available.</p>`;
        return;
      }

      units.forEach(u => {
        const uDiv = document.createElement('div');
        uDiv.className = 'unit-block';
        uDiv.style.marginBottom = '20px';

        const h3 = document.createElement('h3');
        if (u.unit === 0) {
          h3.innerText = 'Syllabus';
        } else if (u.category) {
          h3.innerText = `${u.category} — Unit ${u.unit}`;
        } else {
          h3.innerText = `Unit ${u.unit}`;
        }
        h3.style.margin = '0 0 10px 0';
        h3.style.fontSize = '1.1em';
        h3.style.color = '#333';
        uDiv.appendChild(h3);

        if (u.materials && u.materials.length > 0) {
          u.materials.forEach(m => {
            const d = document.createElement('div');
            d.className = 'paper-card'; // Reuse card style
            const filePath = encodeURI(String(m.file || '').replace(/^\/+/, ''));
            const viewerLink = `viewer.html?file=${encodeURIComponent(filePath)}&title=${encodeURIComponent(m.title)}`;
            d.innerHTML = `
               <div class="paper-info">
                 <div class="paper-title">${m.title}</div>
                 <div class="paper-sub">${m.description || 'Syllabus/Notes'}</div>
               </div>
               <div class="actions">
                 <a class="view-btn" href="${viewerLink}">View</a>
                 <a class="dl-btn" href="${filePath}" download>Download</a>
               </div>
             `;
            uDiv.appendChild(d);
          });
        } else {
          const d = document.createElement('div');
          d.innerText = 'No materials listed.';
          d.style.color = '#777';
          uDiv.appendChild(d);
        }

        area.appendChild(uDiv);
      });
    }

    function applyFilter(val) {
      try {
        if (!val) {
          if (currentView === 'syllabus') renderSyllabus(syllabusData);
          else renderPapers(papersData);
          return;
        }
        val = val.toLowerCase();

        if (currentView === 'syllabus') {
          const filtered = (syllabusData || []).map(u => {
            const unitMatch = (`Unit ${u.unit}`).toLowerCase().includes(val) || (u.category && u.category.toLowerCase().includes(val));
            const matchingMaterials = u.materials ? u.materials.filter(m =>
              (m.title && m.title.toLowerCase().includes(val)) ||
              (m.description && m.description.toLowerCase().includes(val))
            ) : [];

            if (unitMatch) return u;
            else if (matchingMaterials.length > 0) return { ...u, materials: matchingMaterials };
            return null;
          }).filter(u => u !== null);
          renderSyllabus(filtered);
        } else {
          const filtered = (papersData || []).filter(p =>
            String(p.year).includes(val) ||
            (p.title && p.title.toLowerCase().includes(val)) ||
            (p.description && p.description.toLowerCase().includes(val))
          );
          renderPapers(filtered);
        }
      } catch (err) {
        console.error("Filter error:", err);
        const area = document.getElementById('listArea');
        if (area) area.innerHTML = `<p style="color:red">Filter Error: ${err.message}</p>`;
      }
    }

    // filter by year
    document.getElementById('filterYear').addEventListener('input', e => {
      applyFilter(e.target.value.trim());
    });
    document.getElementById('clearFilter').addEventListener('click', () => {
      document.getElementById('filterYear').value = '';
      applyFilter('');
    });

    // Intercept Back link
    (function () {
      const backLink = document.getElementById('backLink');
      if (!backLink) return;
      const fallback = backLink.dataset.fallback || 'index.html';

      function goBack(e) {
        if (e) e.preventDefault();
        if (window.history.length > 1) {
          window.history.back();
        } else {
          window.location.href = fallback;
        }
      }

      backLink.addEventListener('pointerdown', e => { e.preventDefault(); goBack(); });
      backLink.addEventListener('click', e => { goBack(e); });
      backLink.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); goBack(); }
      });
    })();

    // initial load
    loadData();
  </script>
</body>

</html>